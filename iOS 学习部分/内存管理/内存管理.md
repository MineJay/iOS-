# iOS 内存管理


> 

### 一、引用计数（Reference Count）
什么是引用计数呢？它是一个简单而有效的管理对象生命周期的方式。当我们创建一个新对象的时候，它的引用计数为1，当有一个新的指针指向这个对象的时候，将其引用计数加1。而当某个指针不再指向这个对象的时候，将其引用计数减1，当该对象的引用计数为0时，说明这个对象不再被任何指针指向，此时就可以将这个对象销毁。

> 引用计数的管理方式，类似于Linux文件系统中的硬连接。系统检查文件的 link count，只有最后一次删除前，当其等于1时，执行真正的删除操作，把文件所占用的磁盘区域标记成未用。

### 二、那么我们为什么需要引用计数？

引用计数用在面向对象的程序设计架构中，用于对象之间传递和共享数据。举个例子：

> 有对象A、对象 B 两个对象。A 生成了一个对象M，这时，A需要调用 B 的某一方法，将 M 作为参数传递过去。但是 M 面临着一个问题：何时销毁？
> 
> 如果由 A 来销毁，A无法知道 M 对B来说是临时一用？还是非常重要？这时候可以用一个简单粗暴的方法解决：A 调用完 B 以后，立马销毁 M，但如果 M 对 B 来说很重要，那么在销毁之前，将 M 拷贝一份，然后自己管理其生命周期，但是这样太影响性能。
> 
> 如果由 B 来销毁，看似没什么问题，只需要在 B 不需要 M 的时候销毁即可，但是这时候如果 B 向 对象 C 传递 M …… 如此下去，更复杂，更难管理。
> 

所以引用计数很好的解决了这个问题，在传递 M 的过程中，哪些对象需要长时间的使用 M ，就把它的引用计数加1，用完了以后再减1，这样，对象的生命周期就可以完全交给引用计数。

### 三、ARC 下的内存管理问题
ARC 能够解决iOS开发中的绝大多数内存管理问题，担任有少部分需要开发者自己处理（主要是与底层 Core Foundation 对象交互的部分，因为Core Foundation 不在 ARC 的管理下）

#### 循环引用问题
引用计数这种内存管理方式简单，但是不能很好的解决循环引用问题。举个例子：

> 有两个对象 A 和 B，这两个对象相互引用了对方作为自己的成员变量，这时，只有当自己销毁时，才会将成员变量的引用计数减1，这两个对象即使在外界已经没有任何指针指向它们，它们也无法释放，这样就造成了循环引用的问题。如果对象更多，循环越来越大的时候，会非常痛苦。
> 

那么处理这种循环引用问题主要有两个办法：

1.	主动断开：我明确的知道哪里会造成循环引用，根据项目的具体逻辑，在合理的位置，不再需要的时候，主动断开引用。但这种方法更依赖于手动显示地控制完成。
2. 使用弱引用：弱引用持有对象，但是并不会增加引用计数。

> 弱引用的实现原理：系统对于每一个有弱引用的对象，都维护一个表来记录它所有的弱引用的指针地址，通过这样，当一个对象的引用计数为 0 时，系统就可以通过这张表，找到所有的弱引用指针，然后将它们置为 nil。需要注意的是，弱引用的使用是有额外开销的，如果在一个地方用不到它的弱引用特性，就不该使用，不然会增加开销。



























































